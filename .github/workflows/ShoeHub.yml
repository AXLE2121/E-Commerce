# .gitlab-ci.yml
stages:
  - test
  - build
  - deploy

# Cache node_modules to speed up pipelines
cache:
  paths:
    - node_modules/
  key: "$CI_COMMIT_REF_SLUG"

# Variables
variables:
  NODE_VERSION: "18.17.0"
  FIREBASE_PROJECT: "shoehub-711f9"

# Job 1: TEST
test:
  stage: test
  image: node:$NODE_VERSION
  before_script:
    - node --version
    - npm --version
    - echo "Installing dependencies..."
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running tests..."
    
    # Check for required files
    - test -f firebase-data.js && echo "‚úÖ firebase-data.js found" || echo "‚ùå firebase-data.js missing"
    - test -f firebase-auth.js && echo "‚úÖ firebase-auth.js found" || echo "‚ùå firebase-auth.js missing"
    - test -f auth-check.js && echo "‚úÖ auth-check.js found" || echo "‚ùå auth-check.js missing"
    - test -f data.js && echo "‚úÖ data.js found" || echo "‚ùå data.js missing"
    
    # Check for Firebase configuration
    - grep -q "firebaseConfig" firebase-auth.js && echo "‚úÖ Firebase config found" || echo "‚ùå Firebase config missing"
    
    # Run JavaScript linting if ESLint is configured
    - if [ -f .eslintrc.js ] || [ -f .eslintrc.json ]; then
        echo "Running ESLint..."
        npx eslint --ext .js --max-warnings=0 . || echo "ESLint check completed"
      else
        echo "No ESLint config found, skipping linting"
      fi
    
    # Check for syntax errors in main JS files
    - echo "Checking JavaScript syntax..."
    - node -c firebase-data.js
    - node -c firebase-auth.js
    - node -c auth-check.js
    - node -c data.js
    - node -c viewProduct.js
    - node -c admin.js
    - node -c cart.js
    - node -c order-confirmation.js
    
    # Validate HTML files (basic check)
    - echo "Validating HTML files..."
    - find . -name "*.html" -type f | while read file; do
        echo "Checking $file..."
        grep -q "<html" "$file" && echo "‚úÖ $file has valid HTML structure" || echo "‚ö†Ô∏è $file might have HTML issues"
      done
    
    # Security checks
    - echo "Checking for hardcoded sensitive data..."
    - ! grep -r "apiKey.*=.*\"[^\"]*\"" . --include="*.js" --include="*.html" | grep -v "dummy\|example\|test" || (echo "‚ö†Ô∏è Potential API key found" && exit 0)
    
    # Performance check - file sizes
    - echo "Checking file sizes..."
    - find . -name "*.js" -type f -size +200k | while read file; do
        echo "‚ö†Ô∏è Large file: $file ($(stat -c%s "$file") bytes)"
      done
    
  artifacts:
    when: always
    paths:
      - test-reports/
    reports:
      junit:
        - test-reports/*.xml
  only:
    - merge_requests
    - develop
    - main
  tags:
    - docker

# Job 2: BUILD
build:
  stage: build
  image: node:$NODE_VERSION
  dependencies:
    - test
  before_script:
    - echo "Setting up build environment..."
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Building project..."
    
    # Create build directory
    - mkdir -p dist
    
    # Copy all necessary files to dist
    - echo "Copying HTML files..."
    - find . -name "*.html" -not -path "./node_modules/*" -not -path "./dist/*" -exec cp --parents {} dist/ \;
    
    - echo "Copying JavaScript files..."
    - find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" -exec cp --parents {} dist/ \;
    
    - echo "Copying CSS files..."
    - find . -name "*.css" -not -path "./node_modules/*" -not -path "./dist/*" -exec cp --parents {} dist/ \;
    
    - echo "Copying images and assets..."
    - find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" -o -name "*.ico" | 
      grep -v node_modules | grep -v dist | while read file; do
        cp --parents "$file" dist/
      done
    
    # Minify JavaScript files (optional - install terser if needed)
    - echo "Minifying JavaScript files..."
    - if command -v terser &> /dev/null; then
        find dist -name "*.js" -type f | while read file; do
          echo "Minifying $file..."
          terser "$file" -o "$file.min" --compress --mangle &&
          mv "$file.min" "$file"
        done
      else
        echo "Terser not installed, skipping minification"
        echo "To install: npm install -g terser"
      fi
    
    # Create version file
    - echo "Creating version info..."
    - echo "Build: $CI_PIPELINE_ID" > dist/VERSION
    - echo "Commit: $CI_COMMIT_SHORT_SHA" >> dist/VERSION
    - echo "Branch: $CI_COMMIT_REF_NAME" >> dist/VERSION
    - echo "Date: $(date)" >> dist/VERSION
    
    # Generate build report
    - echo "=== BUILD REPORT ===" > dist/build-report.txt
    - echo "Total HTML files: $(find dist -name "*.html" | wc -l)" >> dist/build-report.txt
    - echo "Total JS files: $(find dist -name "*.js" | wc -l)" >> dist/build-report.txt
    - echo "Total CSS files: $(find dist -name "*.css" | wc -l)" >> dist/build-report.txt
    - echo "Total images: $(find dist -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" -o -name "*.svg" | wc -l)" >> dist/build-report.txt
    - echo "Build size: $(du -sh dist | cut -f1)" >> dist/build-report.txt
    
    # Validate Firebase config in build
    - echo "Validating Firebase configuration in build..."
    - if grep -q "apiKey.*AIzaSyCn721TvxMu3R6JX5fpYTXemZPB6alHQX0" dist/firebase-auth.js; then
        echo "‚úÖ Firebase API key found in build"
      else
        echo "‚ùå Firebase API key missing in build"
        exit 1
      fi
    
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  only:
    - merge_requests
    - develop
    - main
  tags:
    - docker

# Job 3: DEPLOY
deploy:
  stage: deploy
  image: node:$NODE_VERSION
  dependencies:
    - build
  before_script:
    - echo "Setting up deployment..."
    - npm install -g firebase-tools
  script:
    - echo "Deploying to Firebase Hosting..."
    
    # Check if we have firebase.json
    - if [ -f firebase.json ]; then
        echo "firebase.json found"
      else
        echo "Creating firebase.json..."
        cat > firebase.json << EOF
        {
          "hosting": {
            "public": "dist",
            "ignore": [
              "firebase.json",
              "**/.*",
              "**/node_modules/**"
            ],
            "rewrites": [
              {
                "source": "**",
                "destination": "/index.html"
              }
            ]
          }
        }
        EOF
      fi
    
    # Different deployment based on branch
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        echo "üöÄ Deploying to PRODUCTION (main branch)..."
        
        # Deploy with specific project ID
        firebase deploy --only hosting --project "$FIREBASE_PROJECT" --token "$FIREBASE_TOKEN" --message "Production deploy: $CI_COMMIT_SHORT_SHA"
        
      elif [ "$CI_COMMIT_BRANCH" == "develop" ]; then
        echo "üîß Deploying to STAGING (develop branch)..."
        
        # Create preview URL for staging
        firebase hosting:channel:deploy "$CI_COMMIT_SHORT_SHA" --project "$FIREBASE_PROJECT" --token "$FIREBASE_TOKEN" --expires 7d
        
      else
        echo "üî¨ Deploying to PREVIEW ($CI_COMMIT_REF_NAME branch)..."
        
        # Create temporary preview deployment
        firebase hosting:channel:deploy "$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA" --project "$FIREBASE_PROJECT" --token "$FIREBASE_TOKEN" --expires 3d
      fi
    
    # Create deployment summary
    - echo "‚úÖ Deployment completed!" > deploy-summary.txt
    - echo "Branch: $CI_COMMIT_REF_NAME" >> deploy-summary.txt
    - echo "Commit: $CI_COMMIT_SHORT_SHA" >> deploy-summary.txt
    - echo "Time: $(date)" >> deploy-summary.txt
    - echo "Project: $FIREBASE_PROJECT" >> deploy-summary.txt
    
  environment:
    name: production
    url: https://$FIREBASE_PROJECT.web.app
  artifacts:
    paths:
      - deploy-summary.txt
  only:
    - main
    - develop
    - merge_requests
  except:
    - tags
  tags:
    - docker

# Optional: Notify job
notify:
  stage: .post
  script:
    - |
      echo "üöÄ Pipeline completed!"
      echo "Pipeline ID: $CI_PIPELINE_ID"
      echo "Status: $CI_JOB_STATUS"
      echo "Commit: $CI_COMMIT_TITLE"
      
      # You can add webhook notifications here
      # Example: curl -X POST -H "Content-Type: application/json" -d '{"text":"Pipeline completed!"}' $SLACK_WEBHOOK_URL
      
  when: always
  needs: []
  tags:
    - docker
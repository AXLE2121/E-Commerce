name: ShoeHub

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

env:
  FIREBASE_PROJECT: 'shoehub-711f9'

jobs:
  test:
    name: Test & Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check file structure
      run: |
        echo "üìÅ Checking project structure..."
        echo "======================"
        find . -type f -name "*.html" | head -10
        echo "======================"
        find . -type f -name "*.js" | head -10
        echo "======================"
        find . -type f -name "*.css" | head -10
        
    - name: Validate HTML files
      run: |
        echo "üîç Validating HTML files..."
        echo "=========================="
        
        # Check for required HTML files
        REQUIRED_HTML_FILES=("index.html" "order-confirmation.html")
        for file in "${REQUIRED_HTML_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
            # Check basic HTML structure
            if grep -q "<!DOCTYPE html>" "$file"; then
              echo "  ‚úì Valid DOCTYPE"
            else
              echo "  ‚ö† Missing DOCTYPE"
            fi
          else
            echo "‚ùå $file missing!"
          fi
        done
        
    - name: Validate JavaScript files
      run: |
        echo "üìú Validating JavaScript files..."
        echo "================================"
        
        # Check JS syntax
        if [ -d "js" ]; then
          for js_file in js/*.js; do
            if [ -f "$js_file" ]; then
              echo "üîé Checking $js_file"
              # Check for syntax errors
              if node -c "$js_file" 2>/dev/null; then
                echo "  ‚úÖ Valid JavaScript syntax"
              else
                echo "  ‚ùå Syntax error in $js_file"
                # Show error
                node -c "$js_file" 2>&1 | head -5
              fi
            fi
          done
        else
          echo "‚ö† js/ directory not found"
        fi
        
        # Check for console logs (optional warning)
        echo "üìù Checking for console logs..."
        CONSOLE_COUNT=$(grep -r "console\." js/ 2>/dev/null | wc -l || echo "0")
        echo "Found $CONSOLE_COUNT console statements"
        
    - name: Check for broken links
      run: |
        echo "üîó Checking for broken image links..."
        echo "=================================="
        
        # Find all image references
        find . -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" \) -exec grep -h -E "(src=|href=|url\(|background.*:)" {} \; | \
          grep -E "\.(jpg|jpeg|png|gif|svg|ico|webp)" | \
          head -20 | while read -r line; do
            echo "Found: $line"
          done
        
    - name: Security check
      run: |
        echo "üîí Running security checks..."
        echo "============================"
        
        # Check for hardcoded API keys (Firebase config)
        echo "Checking for Firebase configuration..."
        if grep -r "apiKey.*:.*['\"]" --include="*.js" --include="*.html" . | grep -v "test\|dummy\|example"; then
          echo "‚ö† Found potential Firebase API key"
          echo "Consider using environment variables for production"
        else
          echo "‚úÖ No hardcoded API keys found"
        fi
        
        # Check for external dependencies
        echo "Checking external dependencies..."
        EXTERNAL_DEPS=$(grep -r "https://" --include="*.html" --include="*.js" --include="*.css" . | \
          grep -E "(cdnjs|googleapis|gstatic|fontawesome|bootstrap)" | wc -l)
        echo "Found $EXTERNAL_DEPS external dependencies"
        
    - name: Run basic tests
      run: |
        echo "üß™ Running basic tests..."
        echo "========================"
        
        # Create a simple test script if it doesn't exist
        if [ ! -f "test.js" ]; then
          cat > test.js << 'EOF'
          // Basic test suite for vanilla JS project
          console.log("üß™ Running Vanilla JS Project Tests");
          console.log("==================================");
          
          // Test 1: Check if main files exist
          const fs = require('fs');
          const path = require('path');
          
          const requiredFiles = [
            'index.html',
            'order-confirmation.html',
            'js/order-confirmation.js',
            'styles/style.css'
          ];
          
          let allFilesExist = true;
          requiredFiles.forEach(file => {
            const exists = fs.existsSync(file);
            console.log(`${exists ? '‚úÖ' : '‚ùå'} ${file} ${exists ? 'exists' : 'missing'}`);
            if (!exists) allFilesExist = false;
          });
          
          // Test 2: Check HTML files
          console.log("\nüìÑ Checking HTML structure...");
          const htmlFiles = fs.readdirSync('.').filter(f => f.endsWith('.html'));
          htmlFiles.forEach(file => {
            const content = fs.readFileSync(file, 'utf8');
            const hasDoctype = content.includes('<!DOCTYPE html>');
            const hasHtmlTag = content.includes('<html');
            const hasHead = content.includes('<head>');
            const hasBody = content.includes('<body>');
            
            console.log(`\n${file}:`);
            console.log(`  ${hasDoctype ? '‚úÖ' : '‚ùå'} DOCTYPE`);
            console.log(`  ${hasHtmlTag ? '‚úÖ' : '‚ùå'} <html> tag`);
            console.log(`  ${hasHead ? '‚úÖ' : '‚ùå'} <head> section`);
            console.log(`  ${hasBody ? '‚úÖ' : '‚ùå'} <body> section`);
          });
          
          // Test 3: Check JS files for common errors
          console.log("\nüìú Checking JavaScript files...");
          if (fs.existsSync('js')) {
            const jsFiles = fs.readdirSync('js').filter(f => f.endsWith('.js'));
            jsFiles.forEach(file => {
              try {
                require(`./js/${file}`);
                console.log(`‚úÖ js/${file} - No syntax errors`);
              } catch (e) {
                console.log(`‚ùå js/${file} - Error: ${e.message.split('\n')[0]}`);
              }
            });
          }
          
          console.log("\nüéâ Test Summary:");
          if (allFilesExist) {
            console.log("‚úÖ All required files present");
            process.exit(0);
          } else {
            console.log("‚ùå Some required files are missing");
            process.exit(1);
          }
          EOF
        fi
        
        # Run the test
        node test.js
        
    - name: Performance check
      run: |
        echo "‚ö° Performance check..."
        echo "====================="
        
        # Check image sizes
        if [ -d "images" ]; then
          echo "Checking image sizes..."
          find images -type f -name "*.jpg" -o -name "*.png" -o -name "*.jpeg" | \
            xargs -I {} sh -c 'echo "  {}: $(identify -format "%wx%h" {} 2>/dev/null || du -h {} | cut -f1)"' | head -10
        fi
        
        # Check CSS file size
        if [ -f "styles/style.css" ]; then
          CSS_SIZE=$(wc -c < styles/style.css)
          echo "CSS file size: $((CSS_SIZE / 1024)) KB"
        fi

  build:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create deployment version
      id: version
      run: |
        # Create a version string
        VERSION="${GITHUB_SHA:0:7}-$(date +%Y%m%d-%H%M)"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "üöÄ Deployment version: $VERSION"
        
    - name: Prepare deployment package
      run: |
        echo "üì¶ Preparing deployment package..."
        
        # Create deployment directory
        mkdir -p deploy
        
        # Copy all necessary files
        echo "üìÅ Copying files..."
        
        # HTML files
        find . -maxdepth 1 -name "*.html" -exec cp {} deploy/ \;
        
        # Directories
        if [ -d "js" ]; then
          cp -r js/ deploy/
        fi
        
        if [ -d "styles" ]; then
          cp -r styles/ deploy/
        fi
        
        if [ -d "images" ]; then
          cp -r images/ deploy/
        fi
        
        # Create deployment info file
        cat > deploy/DEPLOYMENT.md << EOF
        # Deployment Information
        
        - Version: ${{ steps.version.outputs.version }}
        - Commit: ${{ github.sha }}
        - Branch: ${{ github.ref_name }}
        - Timestamp: $(date)
        - Triggered by: ${{ github.actor }}
        
        ## Files Deployed:
        $(find deploy -type f | sort)
        EOF
        
        # Create version file
        echo "${{ steps.version.outputs.version }}" > deploy/VERSION
        
        # Show deployment structure
        echo "üìÅ Deployment structure:"
        find deploy -type f | sort | head -20
        
    - name: Validate deployment package
      run: |
        echo "üîç Validating deployment package..."
        
        REQUIRED_IN_DEPLOY=("index.html" "js/order-confirmation.js")
        
        for file in "${REQUIRED_IN_DEPLOY[@]}"; do
          if [ -f "deploy/$file" ]; then
            echo "‚úÖ deploy/$file exists"
          else
            echo "‚ùå deploy/$file missing!"
            exit 1
          fi
        done
        
        echo "‚úÖ Deployment package validated successfully"
        
    - name: Create deployment archive
      run: |
        echo "üóú Creating deployment archive..."
        
        # Create zip file
        cd deploy && zip -r ../deployment.zip .
        
        # Show archive info
        echo "üì¶ Archive created: deployment.zip"
        echo "üìä Size: $(du -h ../deployment.zip | cut -f1)"
        
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-deployment
        path: |
          deploy/
          deployment.zip
        retention-days: 7

  deploy:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Download deployment artifact
      uses: actions/download-artifact@v4
      with:
        name: web-deployment
        
    - name: Setup Firebase CLI
      run: |
        echo "üöÄ Setting up Firebase CLI..."
        npm install -g firebase-tools
        
    - name: Deploy to Firebase Hosting
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        echo "üåê Deploying to Firebase..."
        
        # Create firebase.json if it doesn't exist
        if [ ! -f "firebase.json" ]; then
          cat > firebase.json << EOF
          {
            "hosting": {
              "public": ".",
              "ignore": [
                "firebase.json",
                "**/.*",
                "**/node_modules/**"
              ],
              "rewrites": [
                {
                  "source": "**",
                  "destination": "/index.html"
                }
              ]
            }
          }
          EOF
          echo "üìÑ Created firebase.json"
        fi
        
        # Deploy to Firebase
        echo "üöÄ Starting deployment..."
        
        # List Firebase projects
        firebase projects:list --token $FIREBASE_TOKEN || true
        
        # Use the specified project
        firebase use $FIREBASE_PROJECT --token $FIREBASE_TOKEN || echo "‚ö† Could not set project, continuing..."
        
        # Deploy hosting
        firebase deploy --only hosting --token $FIREBASE_TOKEN
        
    - name: Post-deployment verification
      run: |
        echo "‚úÖ Deployment completed!"
        echo ""
        echo "üì± Your site is now live at:"
        echo "   üîó https://${{ env.FIREBASE_PROJECT }}.web.app"
        echo "   üîó https://${{ env.FIREBASE_PROJECT }}.firebaseapp.com"
        echo ""
        echo "üìä Version: ${{ needs.build.outputs.version }}"
        echo "üìù Commit: ${{ github.sha }}"
        
    - name: Create deployment summary
      if: always()
      run: |
        echo "# üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ‚úÖ Successfully deployed!" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Project:** ${{ env.FIREBASE_PROJECT }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üåê Live URLs" >> $GITHUB_STEP_SUMMARY
        echo "- üîó [https://${{ env.FIREBASE_PROJECT }}.web.app](https://${{ env.FIREBASE_PROJECT }}.web.app)" >> $GITHUB_STEP_SUMMARY
        echo "- üîó [https://${{ env.FIREBASE_PROJECT }}.firebaseapp.com](https://${{ env.FIREBASE_PROJECT }}.firebaseapp.com)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üìã Files Deployed" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find . -type f -name "*.html" -o -name "*.js" -o -name "*.css" | sort | head -15 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
